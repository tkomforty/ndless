<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Music Generator</title>
  
  <!-- Import Tone.js from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  
  <style>
    /* Base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to bottom, #0f0f1f, #1a1a4a);
      color: white;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Header with neon effect */
    .header {
      text-align: center;
      padding: 30px 0;
    }
    
    .header-content {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .logo {
      width: 200px;
      /* height: 200px; Removed to reduce space */
    }
    
    .logo svg {
      width: 100%;
      height: 100%;
    }
    
    /* Main interface */
    .main-interface {
      background-color: rgba(20, 20, 40, 0.8);
      border-radius: 8px;
      border: 1px solid #2a2a6a;
      backdrop-filter: blur(10px);
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }
    
    /* Controls bar */
    .control-bar {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
      justify-content: center;
    }
    
    .play-button {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .play-button.playing {
      background-color: #ff2a6d;
    }
    
    .play-button.playing:hover {
      background-color: #d6255c;
      box-shadow: 0 4px 15px rgba(255, 42, 109, 0.4);
    }
    
    .play-button.stopped {
      background-color: #05ffa1;
    }
    
    .play-button.stopped:hover {
      background-color: #04d788;
      box-shadow: 0 4px 15px rgba(5, 255, 161, 0.4);
    }
    
    .play-button:disabled {
      opacity: 0.5;
      cursor: wait;
      background-color: #666;
    }
    
    .controls-group {
      display: flex;
      flex-direction: column;
    }
    
    .bpm-control {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .control-label {
      font-size: 0.875rem;
      color: #aaaacc;
    }
    
    .slider {
      height: 8px;
      background-color: #333366;
      border-radius: 4px;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      cursor: pointer;
    }
    
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #ff2a6d;
      cursor: pointer;
    }
    
    .slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #ff2a6d;
      cursor: pointer;
      border: none;
    }
    
    .value-display {
      font-size: 0.875rem;
      font-family: monospace;
      background-color: #222244;
      padding: 4px 8px;
      border-radius: 4px;
    }
    
    .scale-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    
    .select-control {
      background-color: #222244;
      color: white;
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #333366;
      outline: none;
    }
    
    .button-group {
      display: flex;
      gap: 16px;
    }
    
    .action-button {
      background-color: #333366;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .action-button.primary {
      background-color: #3333cc;
    }
    
    .action-button.primary:hover {
      background-color: #4444dd;
    }
    
    .action-button:hover {
      background-color: #444477;
    }
    
    /* Mixer panel */
    .mixer-panel {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      margin-bottom: 24px;
      padding: 16px;
      background-color: rgba(40, 40, 60, 0.5);
      border-radius: 8px;
      border: 1px solid #333366;
    }
    
    .module-panel {
      background-color: rgba(30, 30, 50, 0.7);
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #222244;
    }
    
    .module-title {
      color: #05ffa1;
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .melody-title {
      color: #05ffa1;
    }
    
    .volume-title {
      color: #ff2a6d;
    }
    
    .performance-title {
      color: #fee440;
    }
    
    .knobs-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    
    .knob-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .knob-label {
      font-size: 0.75rem;
      color: #aaaacc;
      margin-bottom: 4px;
    }
    
    .knob {
      position: relative;
      width: 64px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .knob-bg {
      position: absolute;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background-color: #222244;
      border: 1px solid #333366;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    .knob-dial {
      position: absolute;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      transform: rotate(-140deg);
    }
    
    .knob-dial::before {
      content: '';
      position: absolute;
      top: 4px;
      left: 50%;
      width: 2px;
      height: 16px;
      background-color: white;
      transform: translateX(-50%);
      border-radius: 1px;
    }
    
    .knob-value {
      position: absolute;
      font-size: 0.75rem;
      font-family: monospace;
      color: white;
    }
    
    .knob-input {
      position: absolute;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    
    .volume-control {
      margin-bottom: 16px;
    }
    
    .volume-label {
      font-size: 0.75rem;
      color: #aaaacc;
      margin-bottom: 4px;
      display: block;
    }
    
    .volume-slider-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .volume-slider {
      flex: 1;
    }
    
    .status-indicator {
      display: flex;
      align-items: center;
      padding: 8px;
      background-color: #222244;
      border-radius: 8px;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .indicator-light {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: #05ffa1;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }
    
    .indicator-label {
      font-size: 0.75rem;
      color: #ccccee;
    }
    
    .performance-meter {
      padding: 12px;
      background-color: #222244;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    
    .meter-label {
      font-size: 0.75rem;
      color: #aaaacc;
      margin-bottom: 4px;
    }
    
    .meter-bar {
      width: 100%;
      height: 8px;
      background-color: #333366;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .meter-fill {
      height: 100%;
      border-radius: 4px;
    }
    
    .meter-fill.cpu {
      background: linear-gradient(to right, #05ffa1, #05d7b9);
      width: 35%;
    }
    
    .meter-fill.memory {
      background: linear-gradient(to right, #3333cc, #6633cc);
      width: 28%;
    }
    
    /* Visualizer */
    .visualizer-container {
      background-color: rgba(20, 20, 40, 0.8);
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #222244;
      box-shadow: 0 0 20px rgba(5, 255, 161, 0.1);
    }
    
    .visualizer-canvas {
      width: 100%;
      height: 256px;
      border-radius: 8px;
      border: 1px solid #222244;
      background-color: #0f0f1f;
    }
    
    .visualizer-info {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 0.75rem;
      color: #666688;
    }
    
    /* Info panel */
    .info-panel {
      margin-top: 24px;
      background-color: rgba(30, 30, 50, 0.6);
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #222244;
    }
    
    .info-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .info-title {
      color: #ff2a6d;
      font-size: 0.875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .info-badge {
      font-size: 0.75rem;
      color: #aaaacc;
      background-color: #222244;
      padding: 4px 8px;
      border-radius: 9999px;
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      font-size: 0.875rem;
      color: #ccccee;
    }
    
    .info-item-label {
      font-size: 0.75rem;
      color: #666688;
      display: block;
      margin-bottom: 2px;
    }
    
    /* Footer */
    .footer {
      padding: 16px 24px;
      text-align: center;
      color: #05ffa1;
      font-size: 0.75rem;
    }
    
    .footer-links {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-bottom: 8px;
    }
    
    .footer-link {
      color: #05ffa1;
      text-decoration: none;
      transition: color 0.2s;
    }
    
    .footer-link:hover {
      color: white;
    }
    
    /* Hide initially */
    .hidden {
      display: none;
    }
    
    /* Master volume */
    .master-volume-container {
      display: flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(to bottom, #2a2a2a, #1a1a1a);
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 1px 1px rgba(255,255,255,0.1);
      border: 1px solid #333;
    }
    
    .master-volume-container .volume-label {
      color: #fff;
      font-size: 0.9em;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    
    .master-volume-container .slider {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      width: 120px;
      height: 6px;
      background: linear-gradient(to right, #666, #333);
      border-radius: 3px;
      outline: none;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.4);
    }
    
    .master-volume-container .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(to bottom, #fff, #ccc);
      cursor: pointer;
      border: 1px solid #999;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: all 0.2s;
    }
    
    .master-volume-container .slider::-webkit-slider-thumb:hover {
      background: linear-gradient(to bottom, #00ff9d, #00cc7a);
      border-color: #00cc7a;
      transform: scale(1.1);
    }
    
    .master-volume-container .value-display {
      color: #fff;
      font-size: 0.8em;
      min-width: 3em;
      text-align: right;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    
    /* Update melody panel to match mixer style */
    .melody-panel {
      background: rgba(20, 20, 30, 0.95);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(5, 255, 161, 0.2);
      transition: all 0.3s ease;
    }
    
    .melody-panel.hidden {
      display: none;
    }
    
    .melody-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }
    
    .melody-control {
      background: rgba(30, 30, 40, 0.6);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .melody-control label {
      display: block;
      color: #fff;
      font-size: 0.9em;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    
    .melody-control select {
      width: 100%;
      background: #2a2a3a;
      border: 1px solid #444;
      color: #fff;
      padding: 8px;
      border-radius: 4px;
      outline: none;
      transition: all 0.2s;
    }
    
    .melody-control select:focus {
      border-color: #00ff9d;
      box-shadow: 0 0 0 2px rgba(0, 255, 157, 0.2);
    }
    
    .melody-control .slider {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      width: 100%;
      height: 4px;
      background: linear-gradient(to right, #444, #666);
      border-radius: 2px;
      outline: none;
      margin: 10px 0;
    }
    
    .melody-control .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: linear-gradient(to bottom, #fff, #ccc);
      border: 1px solid #666;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .melody-control .slider::-webkit-slider-thumb:hover {
      background: linear-gradient(to bottom, #00ff9d, #00cc7a);
      border-color: #00cc7a;
      transform: scale(1.1);
    }
    
    .melody-control .value-display {
      color: #888;
      font-size: 0.8em;
      text-align: right;
      margin-top: 4px;
    }
    
    /* Responsive design */
    @media (max-width: 600px) {
      .melody-panel, .bass-panel {
        width: 100%;
        padding: 10px;
        box-sizing: border-box;
      }
      .action-button {
        width: 100%;
        font-size: 1.2em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header with neon effect -->
    <header class="header">
      <div class="header-content">
        <div class="logo">
          <h1>Ndless</h1>
        </div>
      </div>
    </header>
    
    <!-- Main interface -->
    <main class="main-interface">
      <!-- Controls bar with play/stop and export -->
      <div class="control-bar">
        <button id="playStopButton" class="play-button stopped" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </button>
        
        <div class="controls-left">
          <div class="bpm-control">
            <span class="control-label">BPM:</span>
            <input id="bpmSlider" type="range" min="60" max="180" value="120" class="slider" style="width: 120px;">
            <span id="bpmValue" class="value-display">120</span>
          </div>
          <div class="scale-controls">
            <select id="scaleSelector" class="select-control">
              <option value="major">Major</option>
              <option value="minor">Minor</option>
              <option value="pentatonic">Pentatonic</option>
              <option value="blues">Blues</option>
              <option value="chromatic">Chromatic</option>
            </select>
            <select id="rootSelector" class="select-control">
              <option value="C4">C</option>
              <option value="C#4">C#</option>
              <option value="D4">D</option>
              <option value="D#4">D#</option>
              <option value="E4">E</option>
              <option value="F4">F</option>
              <option value="F#4">F#</option>
              <option value="G4">G</option>
              <option value="G#4">G#</option>
              <option value="A4">A</option>
              <option value="A#4">A#</option>
              <option value="B4">B</option>
            </select>
          </div>
        </div>
        
        <div class="master-volume-container">
          <label class="volume-label">Master</label>
          <input id="masterVolumeSlider" type="range" min="-40" max="0" value="-10" class="slider">
          <span id="masterVolumeValue" class="value-display">-10</span>
        </div>
        
        <div class="button-group">
          <button id="exportMidiButton" class="action-button primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            Export MIDI
          </button>
          <button id="toggleMixerButton" class="action-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 11l7-7 7 7M5 19l7-7 7 7" />
            </svg>
            Show Mixer
          </button>
          <button id="toggleMelodyButton" class="action-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
            </svg>
            Melody Style
          </button>
          <button id="toggleBassButton" class="action-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
            </svg>
            Bass Style
          </button>
        </div>
      </div>

      <!-- Mixer panel - initially hidden -->
      <div id="mixerPanel" class="mixer-panel hidden">
        <div class="module-panel">
          <h3 class="module-title melody-title">Melody Controls</h3>
          <div class="knobs-grid">
            <div class="knob-container">
              <label class="knob-label">Density</label>
              <div class="knob">
                <div class="knob-bg"></div>
                <div id="densityKnob" class="knob-dial" style="background: conic-gradient(rgba(5, 255, 161, 0.3) 0deg, rgba(5, 255, 161, 0.1) 180deg, transparent 180deg, transparent 360deg);"></div>
                <span id="densityValue" class="knob-value">0.7</span>
                <input id="densityInput" type="range" min="0.1" max="1" step="0.1" value="0.7" class="knob-input">
              </div>
            </div>
            <div class="knob-container">
              <label class="knob-label">Octave</label>
              <div class="knob">
                <div class="knob-bg"></div>
                <div id="octaveKnob" class="knob-dial" style="background: conic-gradient(rgba(5, 255, 161, 0.3) 0deg, rgba(5, 255, 161, 0.1) 180deg, transparent 180deg, transparent 360deg);"></div>
                <span id="octaveValue" class="knob-value">4</span>
                <input id="octaveInput" type="range" min="3" max="6" step="1" value="4" class="knob-input">
              </div>
            </div>
            <div class="knob-container">
              <label class="knob-label">Reverb</label>
              <div class="knob">
                <div class="knob-bg"></div>
                <div id="reverbKnob" class="knob-dial" style="background: conic-gradient(rgba(5, 255, 161, 0.3) 0deg, rgba(5, 255, 161, 0.1) 180deg, transparent 180deg, transparent 360deg);"></div>
                <span id="reverbValue" class="knob-value">0.3</span>
                <input id="reverbInput" type="range" min="0" max="1" step="0.1" value="0.3" class="knob-input">
              </div>
            </div>
            <div class="knob-container">
              <label class="knob-label">Delay</label>
              <div class="knob">
                <div class="knob-bg"></div>
                <div id="delayKnob" class="knob-dial" style="background: conic-gradient(rgba(5, 255, 161, 0.3) 0deg, rgba(5, 255, 161, 0.1) 180deg, transparent 180deg, transparent 360deg);"></div>
                <span id="delayValue" class="knob-value">0.2</span>
                <input id="delayInput" type="range" min="0" max="1" step="0.1" value="0.2" class="knob-input">
              </div>
            </div>
          </div>
        </div>
        
        <div class="module-panel">
          <h3 class="module-title volume-title">Volume Mixer</h3>
          <div class="volume-controls">
            <div class="volume-control">
              <label class="volume-label">Melody</label>
              <div class="volume-slider-container">
                <input id="melodyVolumeSlider" type="range" min="-40" max="0" value="-8" class="slider volume-slider">
                <span id="melodyVolumeValue" class="value-display">-8</span>
              </div>
            </div>
            
            <div class="volume-control">
              <label class="volume-label">Chords</label>
              <div class="volume-slider-container">
                <input id="chordVolumeSlider" type="range" min="-40" max="0" value="-15" class="slider volume-slider">
                <span id="chordVolumeValue" class="value-display">-15</span>
              </div>
            </div>
            
            <div class="volume-control">
              <label class="volume-label">Bass</label>
              <div class="volume-slider-container">
                <input id="bassVolumeSlider" type="range" min="-40" max="0" value="-10" class="slider volume-slider">
                <span id="bassVolumeValue" class="value-display">-10</span>
              </div>
            </div>
            
            <div class="volume-control">
              <label class="volume-label">Drums</label>
              <div class="volume-slider-container">
                <input id="drumsVolumeSlider" type="range" min="-40" max="0" value="-8" class="slider volume-slider">
                <span id="drumsVolumeValue" class="value-display">-8</span>
              </div>
            </div>
            
            <div class="mixer-control">
              <label for="drumsPatternSelect">Drum Pattern</label>
              <select id="drumsPatternSelect" class="select-control">
                <option value="basic">Basic</option>
                <option value="complex">Complex</option>
                <option value="minimal">Minimal</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="module-panel">
          <h3 class="module-title performance-title">Performance</h3>
          <div class="performance-stats">
            <div class="status-indicator">
              <div class="indicator-light"></div>
              <div class="indicator-label">Audio Engine: Active</div>
            </div>
            
            <div class="performance-meter">
              <div class="meter-label">Memory Usage</div>
              <div class="meter-bar">
                <div class="meter-fill memory"></div>
              </div>
            </div>
            
            <div class="performance-meter">
              <div class="meter-label">CPU Load</div>
              <div class="meter-bar">
                <div class="meter-fill cpu"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Melody panel -->
      <div id="melodyPanel" class="melody-panel hidden">
        <h3 class="module-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          Melody Style
        </h3>
        <div class="melody-controls">
          <div class="melody-control">
            <label for="melodyStyleSelect">Style</label>
            <select id="melodyStyleSelect">
              <option value="natural">Natural</option>
              <option value="staccato">Staccato</option>
              <option value="legato">Legato</option>
              <option value="swing">Swing</option>
            </select>
          </div>
          
          <div class="melody-control">
            <label for="complexitySlider">Complexity</label>
            <input type="range" id="complexitySlider" min="0" max="100" value="50" class="slider">
            <span id="complexityValue" class="value-display">50%</span>
          </div>
          
          <div class="melody-control">
            <label for="doublingSelect">Voice Doubling</label>
            <select id="doublingSelect">
              <option value="none">None</option>
              <option value="octave">Octave</option>
              <option value="fifth">Fifth</option>
              <option value="third">Third</option>
            </select>
          </div>
          
          <div class="melody-control">
            <label for="rhythmicVariationSlider">Rhythmic Variation</label>
            <input type="range" id="rhythmicVariationSlider" min="0" max="100" value="30" class="slider">
            <span id="rhythmicVariationValue" class="value-display">30%</span>
          </div>
          
          <div class="melody-control">
            <label for="noteDurationSlider">Note Duration</label>
            <input type="range" id="noteDurationSlider" min="0" max="100" value="50" class="slider">
            <span id="noteDurationValue" class="value-display">50%</span>
          </div>
          
          <div class="melody-control">
            <label for="phrasingSelect">Phrasing</label>
            <select id="phrasingSelect">
              <option value="balanced">Balanced</option>
              <option value="flowing">Flowing</option>
              <option value="choppy">Choppy</option>
              <option value="random">Random</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Bass panel -->
      <div id="bassPanel" class="melody-panel hidden">
        <h3 class="module-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          Bass Style
        </h3>
        <div class="melody-controls">
          <div class="melody-control">
            <label for="bassStyleSelect">Style</label>
            <select id="bassStyleSelect">
              <option value="simple">Simple</option>
              <option value="walking">Walking</option>
              <option value="groovy">Groovy</option>
              <option value="syncopated">Syncopated</option>
            </select>
          </div>
          
          <div class="melody-control">
            <label for="bassComplexitySlider">Complexity</label>
            <input type="range" id="bassComplexitySlider" min="0" max="100" value="50" class="slider">
            <span id="bassComplexityValue" class="value-display">50%</span>
          </div>

          <div class="melody-control">
            <label for="bassRhythmicVariationSlider">Rhythmic Variation</label>
            <input type="range" id="bassRhythmicVariationSlider" min="0" max="100" value="50" class="slider">
            <span id="bassRhythmicVariationValue" class="value-display">50%</span>
          </div>
        </div>
      </div>
      
      <!-- Visualizer -->
      <div class="visualizer-container">
        <h3 class="module-title" style="color: #05d7b9;">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          Sequencer Visualizer
        </h3>
        <canvas id="visualizer" class="visualizer-canvas"></canvas>
        <div class="visualizer-info">
          <div>00:00</div>
          <div>Note Data</div>
          <div>Time</div>
        </div>
      </div>
      
      <!-- Info panel -->
      <div class="info-panel">
        <div class="info-header">
          <h3 class="info-title">Current Composition</h3>
          <div id="scaleInfoBadge" class="info-badge">
            Major Scale • C Key
          </div>
        </div>
        
        <div class="info-grid">
          <div>
            <span class="info-item-label">Melody Density</span>
            <span id="densityInfoValue">70%</span>
          </div>
          <div>
            <span class="info-item-label">Melody Range</span>
            <span id="octaveInfoValue">Octave 4</span>
          </div>
          <div>
            <span class="info-item-label">Effects</span>
            <span id="effectsInfoValue">Reverb: 30%, Delay: 20%</span>
          </div>
        </div>
      </div>
    </main>
    
    <!-- Footer -->
    <footer class="footer">
      
      <p>Endless Generative Music System &copy; <span id="currentYear"></span></p>
    </footer>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Set current year in footer
      document.getElementById('currentYear').textContent = new Date().getFullYear();
      
      // App state
      const state = {
        isPlaying: false,
        bpm: 120,
        scale: 'major',
        root: 'C4',
        melodyDensity: 0.7,
        melodyOctave: 4,
        melodyReverbLevel: 0.3,
        melodyDelayLevel: 0.2,
        bassVolume: -10,
        bassStyle: 'simple',
        bassComplexity: 50,
        bassRhythmicVariation: 50,
        chordVolume: -15,
        melodyVolume: -8,
        drumsVolume: -8,
        masterVolume: -10,
        drumsPattern: 'basic',
        noteHistory: [],
        showMixer: false,
        showMelodyPanel: false,
        recordedNotes: [],
        melodyStyle: 'natural',
        complexity: 50,
        doubling: 'none',
        rhythmicVariation: 30,
        noteDuration: 50,
        phrasing: 'balanced'
      };
      
      // Audio objects
      let synth = null;
      let bass = null;
      let chord = null;
      let drums = null;
      let part = null;
      let sequence = null;
      let reverb = null;
      let delay = null;
      let animationId = null;
      let drumPart = null;
      let bassLine = null;
      
      // DOM Elements - Get all references first
      const playStopButton = document.getElementById('playStopButton');
      const bpmSlider = document.getElementById('bpmSlider');
      const bpmValue = document.getElementById('bpmValue');
      const scaleSelector = document.getElementById('scaleSelector');
      const rootSelector = document.getElementById('rootSelector');
      const exportMidiButton = document.getElementById('exportMidiButton');
      const toggleMixerButton = document.getElementById('toggleMixerButton');
      const toggleMelodyButton = document.getElementById('toggleMelodyButton');
      const toggleBassButton = document.getElementById('toggleBassButton');
      const mixerPanel = document.getElementById('mixerPanel');
      const melodyPanel = document.getElementById('melodyPanel');
      const bassPanel = document.getElementById('bassPanel');
      const visualizer = document.getElementById('visualizer');
      const scaleInfoBadge = document.getElementById('scaleInfoBadge');
      const densityInfoValue = document.getElementById('densityInfoValue');
      const octaveInfoValue = document.getElementById('octaveInfoValue');
      const effectsInfoValue = document.getElementById('effectsInfoValue');
      
      // Knob inputs
      const densityInput = document.getElementById('densityInput');
      const densityKnob = document.getElementById('densityKnob');
      const densityValue = document.getElementById('densityValue');
      
      const octaveInput = document.getElementById('octaveInput');
      const octaveKnob = document.getElementById('octaveKnob');
      const octaveValue = document.getElementById('octaveValue');
      
      const reverbInput = document.getElementById('reverbInput');
      const reverbKnob = document.getElementById('reverbKnob');
      const reverbValue = document.getElementById('reverbValue');
      
      const delayInput = document.getElementById('delayInput');
      const delayKnob = document.getElementById('delayKnob');
      const delayValue = document.getElementById('delayValue');
      
      const melodyVolumeSlider = document.getElementById('melodyVolumeSlider');
      const melodyVolumeValue = document.getElementById('melodyVolumeValue');
      
      const chordVolumeSlider = document.getElementById('chordVolumeSlider');
      const chordVolumeValue = document.getElementById('chordVolumeValue');
      
      const bassVolumeSlider = document.getElementById('bassVolumeSlider');
      const bassVolumeValue = document.getElementById('bassVolumeValue');
      
      const drumsVolumeSlider = document.getElementById('drumsVolumeSlider');
      const drumsVolumeValue = document.getElementById('drumsVolumeValue');
      
      const drumsPatternSelect = document.getElementById('drumsPatternSelect');
      
      const masterVolumeSlider = document.getElementById('masterVolumeSlider');
      const masterVolumeValue = document.getElementById('masterVolumeValue');
      
      const melodyStyleSelect = document.getElementById('melodyStyleSelect');
      const complexitySlider = document.getElementById('complexitySlider');
      const complexityValue = document.getElementById('complexityValue');
      const doublingSelect = document.getElementById('doublingSelect');
      const rhythmicVariationSlider = document.getElementById('rhythmicVariationSlider');
      const rhythmicVariationValue = document.getElementById('rhythmicVariationValue');
      const noteDurationSlider = document.getElementById('noteDurationSlider');
      const noteDurationValue = document.getElementById('noteDurationValue');
      const phrasingSelect = document.getElementById('phrasingSelect');
      
      const bassStyleSelect = document.getElementById('bassStyleSelect');
      const bassComplexitySlider = document.getElementById('bassComplexitySlider');
      const bassComplexityValue = document.getElementById('bassComplexityValue');
      const bassRhythmicVariationSlider = document.getElementById('bassRhythmicVariationSlider');
      const bassRhythmicVariationValue = document.getElementById('bassRhythmicVariationValue');
      
      // Music theory data
      const scales = {
        major: [0, 2, 4, 5, 7, 9, 11],
        minor: [0, 2, 3, 5, 7, 8, 10],
        pentatonic: [0, 2, 4, 7, 9],
        blues: [0, 3, 5, 6, 7, 10],
        chromatic: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
      };
      
      const rootNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
      
      // Disable play button initially
      playStopButton.disabled = true;
      playStopButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      `;
      
      // Initialize knobs with starting values
      function updateKnob(knobElement, value, min, max) {
        const rotation = 280 * ((value - min) / (max - min)) - 140;
        knobElement.style.transform = `rotate(${rotation}deg)`;
      }
      
      updateKnob(densityKnob, state.melodyDensity, 0.1, 1);
      updateKnob(octaveKnob, state.melodyOctave, 3, 6);
      updateKnob(reverbKnob, state.melodyReverbLevel, 0, 1);
      updateKnob(delayKnob, state.melodyDelayLevel, 0, 1);
      
      // Initialize audio system
      async function initAudioSystem() {
        // Set up audio effects
        reverb = new Tone.Reverb({
          decay: 2.5,
          wet: state.melodyReverbLevel
        }).toDestination();
        
        delay = new Tone.FeedbackDelay({
          delayTime: "8n",
          feedback: 0.3,
          wet: state.melodyDelayLevel
        }).connect(reverb);
        
        // Set up synthesizers
        synth = new Tone.PolySynth(Tone.Synth, {
          volume: state.melodyVolume,
          envelope: {
            attack: 0.02,
            decay: 0.1,
            sustain: 0.3,
            release: 1
          }
        }).connect(delay);
        
 // Enhanced bass synth with more options
// Replace the bass initialization in initAudioSystem() with this:
bass = new Tone.MonoSynth({
  volume: state.bassVolume,
  oscillator: {
    type: "sine"
  },
  envelope: {
    attack: 0.05,
    decay: 0.2,
    sustain: 0.8,
    release: 1.5
  },
  filter: {
    Q: 2,
    type: "lowpass",
    rolloff: -24
  },
  filterEnvelope: {
    attack: 0.05,
    decay: 0.5,
    sustain: 0.2,
    release: 2,
    baseFrequency: 200,
    octaves: 2
  }
}).toDestination();

// Add a light compressor for bass to even out dynamics
const bassCompressor = new Tone.Compressor({
  threshold: -20,
  ratio: 4,
  attack: 0.005,
  release: 0.1
}).toDestination();

// Connect bass to compressor
bass.disconnect(); // Disconnect from destination
bass.connect(bassCompressor); // Connect to compressor instead
        
        chord = new Tone.PolySynth(Tone.Synth, {
          volume: state.chordVolume,
          envelope: {
            attack: 0.05,
            decay: 0.2,
            sustain: 0.4,
            release: 1.5
          }
        }).toDestination();
        
        // Generate drum sounds using Web Audio API
        async function generateDrumSounds() {
          const ctx = Tone.context;
          const sampleRate = ctx.sampleRate;
          
          // Generate kick drum
          function generateKick() {
            const duration = 0.25;
            const bufferSize = duration * sampleRate;
            const buffer = ctx.createBuffer(1, bufferSize, sampleRate);
            const data = buffer.getChannelData(0);
            
            const frequency = 150;
            const decay = 5;
            
            for (let i = 0; i < bufferSize; i++) {
              const t = i / sampleRate;
              const frequency_slide = frequency * Math.exp(-decay * t);
              data[i] = Math.sin(2 * Math.PI * frequency_slide * t) * Math.exp(-decay * t);
            }
            
            return buffer;
          }
          
          // Generate snare drum
          function generateSnare() {
            const duration = 0.25;
            const bufferSize = duration * sampleRate;
            const buffer = ctx.createBuffer(1, bufferSize, sampleRate);
            const data = buffer.getChannelData(0);
            
            const noiseLength = duration * sampleRate;
            const noise = new Float32Array(noiseLength);
            for (let i = 0; i < noiseLength; i++) {
              noise[i] = Math.random() * 2 - 1;
            }
            
            for (let i = 0; i < bufferSize; i++) {
              const t = i / sampleRate;
              const envelope = Math.exp(-8 * t);
              data[i] = noise[i] * envelope;
            }
            
            return buffer;
          }
          
          // Generate hi-hat
          function generateHiHat() {
            const duration = 0.1;
            const bufferSize = duration * sampleRate;
            const buffer = ctx.createBuffer(1, bufferSize, sampleRate);
            const data = buffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
              const t = i / sampleRate;
              const envelope = Math.exp(-30 * t);
              data[i] = (Math.random() * 2 - 1) * envelope;
            }
            
            return buffer;
          }
          
          return {
            kick: generateKick(),
            snare: generateSnare(),
            hihat: generateHiHat()
          };
        }
        
        // Create drum sampler using generated sounds
        const drumSounds = await generateDrumSounds();
        drums = new Tone.Players({
          kick: new Tone.Buffer(drumSounds.kick),
          snare: new Tone.Buffer(drumSounds.snare),
          hihat: new Tone.Buffer(drumSounds.hihat)
        }).toDestination();
        
        drums.volume.value = state.drumsVolume;
        drums.loaded = true;
        
        // Enable play button
        playStopButton.disabled = false;
        playStopButton.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        `;
        console.log("Drum sounds generated successfully");
        
        // Set Tone.js tempo
        Tone.Transport.bpm.value = state.bpm;
        
        // Initialize audio context
        await Tone.start();
        console.log("Audio system initialized");
        
        // Set master volume
        Tone.Destination.volume.value = state.masterVolume;
      }
      
      // Update audio parameters
      function updateAudioParams() {
        if (reverb) reverb.wet.value = state.melodyReverbLevel;
        if (delay) delay.wet.value = state.melodyDelayLevel;
        if (synth) synth.volume.value = state.melodyVolume;
        if (bass) bass.volume.value = state.bassVolume;
        if (chord) chord.volume.value = state.chordVolume;
        if (drums) drums.volume.value = state.drumsVolume;
        if (Tone.Transport) Tone.Transport.bpm.value = state.bpm;
        if (Tone.Destination) Tone.Destination.volume.value = state.masterVolume;
        
        // Update UI displays
        updateInfoPanel();
      }
      
      // Helper function to update bass synth settings based on style
function updateBassSynthSettings() {
  if (!bass) return;
  
  // Base settings
  const baseSettings = {
    volume: state.bassVolume,
    envelope: {
      attack: 0.05,
      decay: 0.2,
      sustain: 0.8,
      release: 1.5
    },
    filterEnvelope: {
      attack: 0.05,
      decay: 0.5,
      sustain: 0.2,
      release: 2,
      baseFrequency: 200,
      octaves: 2
    }
  };
  
  // Modify settings based on style
  switch(state.bassStyle) {
    case 'simple':
      // Full, sustained bass
      bass.set({
        oscillator: { type: "sine" },
        envelope: {
          ...baseSettings.envelope,
          attack: 0.08,
          sustain: 0.9,
          release: 2
        }
      });
      break;
      
    case 'walking':
      // More defined attack, less sustain for walking bass
      bass.set({
        oscillator: { type: "triangle" },
        envelope: {
          ...baseSettings.envelope,
          attack: 0.02,
          decay: 0.15,
          sustain: 0.6,
          release: 0.8
        },
        filterEnvelope: {
          ...baseSettings.filterEnvelope,
          baseFrequency: 300,
          octaves: 3
        }
      });
      break;
      
    case 'groovy':
      // Punchier, more resonant sound for groove patterns
      bass.set({
        oscillator: { type: "triangle4" },
        envelope: {
          ...baseSettings.envelope,
          attack: 0.01,
          decay: 0.3,
          sustain: 0.5,
          release: 0.6
        },
        filterEnvelope: {
          ...baseSettings.filterEnvelope,
          attack: 0.02,
          decay: 0.2,
          baseFrequency: 400,
          octaves: 4
        }
      });
      break;
      
    case 'syncopated':
      // Sharp attack for clear syncopation
      bass.set({
        oscillator: { type: "fmsquare" },
        envelope: {
          ...baseSettings.envelope,
          attack: 0.005,
          decay: 0.1,
          sustain: 0.3,
          release: 0.4
        },
        filterEnvelope: {
          ...baseSettings.filterEnvelope,
          attack: 0.01,
          decay: 0.1,
          baseFrequency: 500,
          octaves: 5
        }
      });
      break;
  }
}
      
      // Update the info panel
      function updateInfoPanel() {
        scaleInfoBadge.textContent = `${state.scale.charAt(0).toUpperCase() + state.scale.slice(1)} Scale • ${state.root.slice(0, -1)} Key`;
        densityInfoValue.textContent = `${(state.melodyDensity * 100).toFixed(0)}%`;
        octaveInfoValue.textContent = `Octave ${state.melodyOctave}`;
        effectsInfoValue.textContent = `Reverb: ${(state.melodyReverbLevel * 100).toFixed(0)}%, Delay: ${(state.melodyDelayLevel * 100).toFixed(0)}%`;
      }
      
      // Generate a note from the current scale
      function generateNote(octave) {
        const currentScale = scales[state.scale];
        const degree = Math.floor(Math.random() * currentScale.length);
        const noteNum = rootNotes.indexOf(state.root.slice(0, -1));
        const noteOctave = parseInt(octave || state.root.slice(-1));
        const note = rootNotes[(noteNum + currentScale[degree]) % 12] + noteOctave;
        return note;
      }
      
      // Generate chord progression based on the scale
      function generateChordProgression() {
        const currentScale = scales[state.scale];
        const degrees = [0, 3, 4, 0, 2, 5, 1, 4].filter(() => Math.random() > 0.3);
        const rootNum = rootNotes.indexOf(state.root.slice(0, -1));
        const rootOct = parseInt(state.root.slice(-1));
        
        return degrees.map(degree => {
          const chordBase = rootNotes[(rootNum + currentScale[degree % currentScale.length]) % 12];
          const chordNotes = [0, 2, 4].map(interval => {
            const scaleDegree = (degree + interval) % currentScale.length;
            const note = rootNotes[(rootNum + currentScale[scaleDegree]) % 12];
            const octave = rootOct + (note < chordBase ? 1 : 0);
            return note + octave;
          });
          return chordNotes;
        });
      }
      
      // Generate bassline
 function generateBassline(chords) {
  const bassNotes = [];
  const rootOctave = parseInt(state.root.slice(-1)) - 1; // Bass typically one octave below
  
  chords.forEach((chord, index) => {
    const rootNote = chord[0].slice(0, -1); // Get note without octave
    const rootNoteIndex = rootNotes.indexOf(rootNote);
    const scaleType = scales[state.scale];
    
    // Extract chord information
    const chordRoot = rootNotes.indexOf(chord[0].slice(0, -1));
    
    // Different patterns based on style
    switch(state.bassStyle) {
      case 'simple':
        // Just root notes on the first beat of each measure
        bassNotes.push({
          note: rootNote + rootOctave,
          time: `${index}:0:0`,
          duration: '2n'
        });
        break;
        
      case 'walking':
        // Walking bass - root, 5th, approach notes, passing tones
        bassNotes.push({
          note: rootNote + rootOctave,
          time: `${index}:0:0`,
          duration: '4n'
        });
        
        // Fifth on beat 2
        const fifthNote = rootNotes[(rootNoteIndex + 7) % 12] + rootOctave;
        bassNotes.push({
          note: fifthNote,
          time: `${index}:1:0`,
          duration: '4n'
        });
        
        // Approach notes on beats 3 and 4
        // If there's a next chord, approach its root
        const nextChordIndex = (index + 1) % chords.length;
        const nextRoot = chords[nextChordIndex][0].slice(0, -1);
        const nextRootIndex = rootNotes.indexOf(nextRoot);
        
        // Determine approach direction
        const stepDown = rootNotes[(nextRootIndex + 11) % 12] + rootOctave;
        bassNotes.push({
          note: rootNote + rootOctave,
          time: `${index}:2:0`,
          duration: '4n'
        });
        
        bassNotes.push({
          note: stepDown,
          time: `${index}:3:0`,
          duration: '4n'
        });
        break;
      
      case 'groovy':
        // Groovy pattern with syncopation and octave jumps
        const complexityFactor = state.bassComplexity / 100;
        
        // Root on beat 1
        bassNotes.push({
          note: rootNote + rootOctave,
          time: `${index}:0:0`,
          duration: '8n'
        });
        
        // Syncopated pattern - varies with complexity
        if (complexityFactor > 0.4) {
          bassNotes.push({
            note: rootNote + rootOctave,
            time: `${index}:1:2`,
            duration: '8n'
          });
        }
        
        if (complexityFactor > 0.2) {
          bassNotes.push({
            note: rootNote + rootOctave,
            time: `${index}:2:0`,
            duration: '8n'
          });
        }
        
        // Octave jump at end with high complexity
        if (complexityFactor > 0.6) {
          bassNotes.push({
            note: rootNote + (rootOctave + 1),
            time: `${index}:3:0`, 
            duration: '8n'
          });
          
          bassNotes.push({
            note: rootNote + rootOctave,
            time: `${index}:3:2`, 
            duration: '8n'
          });
        } else {
          bassNotes.push({
            note: rootNote + rootOctave,
            time: `${index}:3:0`,
            duration: '4n'
          });
        }
        break;
        
      case 'syncopated':
        // Complex syncopated patterns based on rhythmic variation
        const variationAmount = state.bassRhythmicVariation / 100;
        
        // Create a syncopated pattern with variable density
        const patternDensity = Math.max(2, Math.floor(4 + 4 * variationAmount));
        const syncopatedPositions = [];
        
        // First position is always the root
        syncopatedPositions.push(0);
        
        // Add more positions based on rhythmic variation
        for (let i = 0; i < patternDensity; i++) {
          // Avoid straight beats more as variation increases
          let position;
          do {
            position = Math.floor(Math.random() * 16); // 16 sixteenth notes per bar
          } while (
            syncopatedPositions.includes(position) || 
            (variationAmount > 0.5 && position % 4 === 0) // Avoid downbeats with high variation
          );
          
          syncopatedPositions.push(position);
        }
        
        // Sort positions chronologically
        syncopatedPositions.sort((a, b) => a - b);
        
        // Create notes with syncopated rhythm
        syncopatedPositions.forEach(pos => {
          const beat = Math.floor(pos / 4);
          const sixteenth = pos % 4;
          
          // Choose note - sometimes fifth or third instead of root
          let note = rootNote;
          if (Math.random() < variationAmount * 0.5) {
            // Add fifth or third occasionally
            const interval = Math.random() > 0.5 ? 7 : 4;
            note = rootNotes[(rootNoteIndex + interval) % 12];
          }
          
          bassNotes.push({
            note: note + rootOctave,
            time: `${index}:${beat}:${sixteenth}`,
            duration: '16n'
          });
        });
        break;
    }
  });
  
  return bassNotes;
}
      
      // Generate a melody based on parameters
      function generateMelody(bars = 8) {
        const melody = [];
        
        // Ensure we have enough density by guaranteeing at least some notes per bar
        const minNotesPerBar = Math.max(1, Math.floor(state.melodyDensity * 6));
        
        for (let bar = 0; bar < bars; bar++) {
          // Ensure minimum notes per bar
          let notesInCurrentBar = 0;
          
          for (let i = 0; i < 16; i++) { // 16 sixteenth notes per bar
            // Higher chance of notes on strong beats (first beat of each quarter note)
            const isStrongBeat = i % 4 === 0;
            const chanceMultiplier = isStrongBeat ? 1.5 : 1;
            
            if (Math.random() < state.melodyDensity * 0.3 * chanceMultiplier || 
                (notesInCurrentBar < minNotesPerBar && i >= 12)) { 
              
              // Format as bar:quarter:sixteenth
              const time = `${bar}:${Math.floor(i / 4)}:${i % 4}`;
              const noteOctave = state.melodyOctave;
              const note = generateNote(noteOctave);
              
              // Weighted duration distribution favoring shorter notes
              const durationOptions = ['16n', '8n', '8n', '8n.', '4n'];
              const duration = durationOptions[Math.floor(Math.random() * durationOptions.length)];
              
              melody.push({
                note,
                time,
                duration
              });
              
              notesInCurrentBar++;
            }
          }
        }
        
        return melody;
      }
      
      // Generate drum pattern
      function generateDrumPattern(bars = 8) {
        const patterns = {
          basic: {
            kick: ['kick', null, null, null, 'kick', null, null, null],
            snare: [null, null, 'snare', null, null, null, 'snare', null],
            hihat: ['hihat', null, 'hihat', null, 'hihat', null, 'hihat', null]
          },
          complex: {
            kick: ['kick', null, 'kick', null, 'kick', null, 'kick', 'kick'],
            snare: [null, null, 'snare', null, null, null, 'snare', 'snare'],
            hihat: ['hihat', 'hihat', 'hihat', 'hihat', 'hihat', 'hihat', 'hihat', 'hihat']
          },
          minimal: {
            kick: ['kick', null, null, null, 'kick', null, null, null],
            snare: [null, null, 'snare', null, null, null, 'snare', null],
            hihat: ['hihat', null, null, null, 'hihat', null, null, null]
          }
        };
        
        const selectedPattern = patterns[state.drumsPattern];
        const drumPattern = [];
        
        for (let bar = 0; bar < bars; bar++) {
          Object.entries(selectedPattern).forEach(([drum, pattern]) => {
            pattern.forEach((sound, i) => {
              if (sound) {
                drumPattern.push({
                  sound: sound,
                  time: `${bar}:${Math.floor(i/2)}:${i%2}`,
                  duration: '16n'
                });
              }
            });
          });
        }
        
        return drumPattern;
      }
      
      // Start or stop the music
      async function togglePlay() {
        if (state.isPlaying) {
          Tone.Transport.stop();
          if (part) part.dispose();
          if (sequence) sequence.dispose();
          if (drumPart) drumPart.dispose();
          if (animationId) cancelAnimationFrame(animationId);
          
          state.isPlaying = false;
          updatePlayButton();
          return;
        }
        
        // Reset state for new playback
        state.recordedNotes = [];
        state.noteHistory = [];
        
        // Get length of chord progression (in measures)
        const chordProgressionLength = 8; // 8 measures total
        
        // Generate chord progression
        const chords = generateChordProgression();
        
        // Generate bassline from chords
        const bassline = generateBassline(chords);
        
        // Generate melody that spans the entire chord progression length
        const melody = generateMelody(chordProgressionLength);
        
        // Generate drum pattern
        const drumPattern = generateDrumPattern(chordProgressionLength);
        
        // Clear any existing parts
        if (part) part.dispose();
        if (sequence) sequence.dispose();
        if (drumPart) drumPart.dispose();
        
        // Set up transports and sequences
        Tone.Transport.bpm.value = state.bpm;
        Tone.Transport.timeSignature = [4, 4];
        Tone.Transport.loop = true;
        Tone.Transport.loopEnd = `${chordProgressionLength}m`;
        
        // Play melody
        part = new Tone.Part((time, note) => {
          synth.triggerAttackRelease(note.note, note.duration, time);
          
          // Record notes for visualization and MIDI export
          state.recordedNotes.push({
            note: note.note,
            time: Tone.Transport.seconds + Tone.Time(time).toSeconds(),
            duration: Tone.Time(note.duration).toSeconds()
          });
          
          state.noteHistory.push(note.note);
          if (state.noteHistory.length > 16) {
            state.noteHistory = state.noteHistory.slice(-16);
          }
        }, melody).start(0);
        
        // Play chords and bass simultaneously with melody
 // Find this section in togglePlay() function:
// Play chords and bass simultaneously with melody
// Play chords
// Replace the chord and bass sequence in togglePlay() with this:

// Play chords
sequence = new Tone.Sequence((time, idx) => {
  if (idx < chords.length) {
    chord.triggerAttackRelease(chords[idx], "2n", time);
    
    // Record chord notes for visualization
    chords[idx].forEach(chordNote => {
      state.recordedNotes.push({
        note: chordNote,
        time: Tone.Transport.seconds + Tone.Time(time).toSeconds(),
        duration: Tone.Time("2n").toSeconds()
      });
    });
  }
}, [...Array(chords.length).keys()], "1m").start(0);

// Create bass part with the current style settings
const bassNotes = generateBassline(chords);
bassLine = new Tone.Part((time, event) => {
  let adjustedTime = time;
  
  // Add subtle timing variation for groovy and walking bass
  if (state.bassStyle === 'groovy' || state.bassStyle === 'walking') {
    const variationAmount = state.bassRhythmicVariation / 100;
    adjustedTime += (Math.random() * 0.02 - 0.01) * variationAmount;
  }
  
  // Extract the actual note and duration from the event
  const noteValue = event.note;
  const durationValue = event.duration;
  
  bass.triggerAttackRelease(noteValue, durationValue, adjustedTime);
  
  // Record bass note for visualization
  state.recordedNotes.push({
    note: noteValue,
    time: adjustedTime, // Use the adjusted time directly
    duration: Tone.Time(durationValue).toSeconds()
  });
}, bassNotes).start(0);

// Update bass synth settings for the current style
updateBassSynthSettings();
        
        // Play drum pattern
        drumPart = new Tone.Part((time, event) => {
          if (drums.loaded) {
            drums.player(event.sound).start(time);
          }
        }, drumPattern).start(0);
        
        // Start the transport
        Tone.Transport.start();
        
        // Start visualizer
        renderVisualizer();
        
        state.isPlaying = true;
        updatePlayButton();
      }
      
      // Update play button appearance
      function updatePlayButton() {
        if (state.isPlaying) {
          playStopButton.classList.remove('stopped');
          playStopButton.classList.add('playing');
          playStopButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 18M6 6L18 6" />
            </svg>
          `;
        } else {
          playStopButton.classList.remove('playing');
          playStopButton.classList.add('stopped');
          playStopButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          `;
        }
      }
      
      // Toggle mixer panel
      function toggleMixer() {
        state.showMixer = !state.showMixer;
        
        if (state.showMixer) {
          mixerPanel.classList.remove('hidden');
          toggleMixerButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 13l-7 7-7-7M5 19l7-7 7 7" />
            </svg>
            Hide Mixer
          `;
        } else {
          mixerPanel.classList.add('hidden');
          toggleMixerButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 11l7-7 7 7M5 19l7-7 7 7" />
            </svg>
            Show Mixer
          `;
        }
      }
      
      // Toggle melody style panel
      function toggleMelodyStyle() {
        state.showMelodyPanel = !state.showMelodyPanel;
        
        if (state.showMelodyPanel) {
          melodyPanel.classList.remove('hidden');
          toggleMelodyButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
            </svg>
            Hide Melody Style
          `;
        } else {
          melodyPanel.classList.add('hidden');
          toggleMelodyButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
            </svg>
            Melody Style
          `;
        }
      }
      
      // Toggle bass style panel
      function toggleBassStyle() {
        state.showBassPanel = !state.showBassPanel;
        
        if (state.showBassPanel) {
          bassPanel.classList.remove('hidden');
          toggleBassButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
            </svg>
            Hide Bass Style
          `;
        } else {
          bassPanel.classList.add('hidden');
          toggleBassButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
            </svg>
            Bass Style
          `;
        }
      }
      
      // Update knob rotation and value
      function updateKnob(knobElement, value, min, max) {
        const rotation = 280 * ((value - min) / (max - min)) - 140;
        knobElement.style.transform = `rotate(${rotation}deg)`;
      }
      
      // Export MIDI
      function exportMidi() {
        if (state.recordedNotes.length === 0) {
          showNotification("No notes to export. Please generate a melody first.", "warning");
          return;
        }
        
        // Load MidiWriter script dynamically
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/midi-writer-js/2.1.4/midi-writer-js.min.js';
        script.async = true;
        
        script.onload = () => {
          try {
            // Create a new MIDI writer track
            const track = new MidiWriter.Track();
            
            // Add tempo
            track.setTempo(state.bpm);
            
            // Get all notes
            const allNotes = [...state.recordedNotes];
            
            // Find the earliest time stamp
            let earliestTime = Number.MAX_VALUE;
            allNotes.forEach(note => {
              if (note.time < earliestTime) {
                earliestTime = note.time;
              }
            });
            
            // Normalize times to start at 0
            const normalizedNotes = allNotes.map(note => ({
              ...note,
              time: note.time - earliestTime
            }));
            
            // Sort by start time
            normalizedNotes.sort((a, b) => a.time - b.time);
            
            // Add notes to track
            normalizedNotes.forEach(note => {
              const midiNote = Tone.Frequency(note.note).toMidi();
              const duration = Math.max(1, Math.round(note.duration * 4)); // Convert to quarter notes
              
              // Create note event
              const noteEvent = new MidiWriter.NoteEvent({
                pitch: midiNote,
                duration: 'T' + (64 / duration),
                velocity: 100
              });
              
              track.addEvent(noteEvent);
            });
            
            // Generate MIDI file
            const write = new MidiWriter.Writer([track]);
            
            // Format key for filename (remove octave number)
            const keyForFilename = state.root.replace(/[0-9]/g, '');
            
            // Create filename with key and scale
            const filename = `${keyForFilename}_${state.scale}_composition.mid`;
            
            // Create download link
            const downloadLink = document.createElement('a');
            downloadLink.href = write.dataUri();
            downloadLink.download = filename;
            downloadLink.click();
            
            showNotification(`Created MIDI file: ${filename}`, "success");
          } catch (error) {
            console.error('MIDI export error:', error);
            showNotification(`MIDI export failed: ${error.message}`, "error");
          }
        };
        
        script.onerror = () => {
          console.error('Failed to load MidiWriter library');
          showNotification("Failed to export MIDI. Library not available.", "error");
        };
        
        document.head.appendChild(script);
      }
      
      // Helper to show notifications
      function showNotification(message, type = "success", duration = 3000) {
        // Create notification element
        const notification = document.createElement('div');
        notification.textContent = message;
        notification.className = 'midi-notification';
        
        // Set styles based on type
        const colors = {
          success: '#05ffa1',
          warning: '#fee440',
          error: '#ff2a6d',
          info: '#05d7b9'
        };
        
        notification.style.position = 'fixed';
        notification.style.bottom = '20px';
        notification.style.left = '50%';
        notification.style.transform = 'translateX(-50%)';
        notification.style.padding = '12px 24px';
        notification.style.backgroundColor = colors[type] || colors.success;
        notification.style.color = '#0f0f1f';
        notification.style.borderRadius = '4px';
        notification.style.zIndex = '9999';
        notification.style.textAlign = 'center';
        notification.style.maxWidth = '80%';
        notification.style.boxShadow = `0 4px 8px rgba(0, 0, 0, 0.3), inset 0 1px 1px rgba(255,255,255,0.1)`;
        notification.style.fontWeight = '500';
        
        // Remove any existing notifications
        const existingNotifications = document.querySelectorAll('.midi-notification');
        existingNotifications.forEach(notif => {
          if (document.body.contains(notif)) {
            document.body.removeChild(notif);
          }
        });
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          if (document.body.contains(notification)) {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(-50%) translateY(20px)';
            notification.style.transition = 'opacity 0.5s, transform 0.5s';
            
            setTimeout(() => {
              if (document.body.contains(notification)) {
                document.body.removeChild(notification);
              }
            }, 500);
          }
        }, duration);
      }
      
      // Render the visualizer
      function renderVisualizer() {
        const canvas = visualizer;
        const ctx = canvas.getContext('2d');
        
        // Set canvas dimensions
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;
        
        const width = canvas.width;
        const height = canvas.height;
        
        function drawVisualizer() {
          ctx.clearRect(0, 0, width, height);
          
          // Draw background - gradient
          const gradient = ctx.createLinearGradient(0, 0, 0, height);
          gradient.addColorStop(0, '#0f0f17');
          gradient.addColorStop(1, '#1a1a2e');
          ctx.fillStyle = gradient;
          ctx.fillRect(0, 0, width, height);
          
          // Draw grid with glow
          ctx.save();
          ctx.shadowColor = '#00f2ff';
          ctx.shadowBlur = 5;
          ctx.strokeStyle = '#00f2ff30';
          ctx.lineWidth = 1;
          
          // Vertical lines (time divisions)
          for (let i = 0; i <= 16; i++) {
            const x = width * (i / 16);
            ctx.globalAlpha = i % 4 === 0 ? 0.5 : 0.2;
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, height);
            ctx.stroke();
          }
          
          // Horizontal lines (note divisions)
          for (let i = 0; i <= 12; i++) {
            const y = height * (i / 12);
            ctx.globalAlpha = i % 12 === 0 ? 0.5 : 0.2;
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(width, y);
            ctx.stroke();
          }
          ctx.restore();
          
          // Draw playhead with glow
          const progress = (Tone.Transport.progress * width) % width;
          ctx.save();
          ctx.shadowColor = '#ff2a6d';
          ctx.shadowBlur = 15;
          ctx.strokeStyle = '#ff2a6d';
          ctx.lineWidth = 2;
          ctx.globalAlpha = 0.8;
          ctx.beginPath();
          ctx.moveTo(progress, 0);
          ctx.lineTo(progress, height);
          ctx.stroke();
          ctx.restore();
          
          // Draw recorded notes with neon glow effect
          state.recordedNotes.forEach(note => {
            const noteNumber = Tone.Frequency(note.note).toMidi();
            const normalizedPitch = 127 - noteNumber; // Flip so higher notes are at the top
            
            // Map MIDI note to Y position (0-127 range to canvas height)
            const y = (normalizedPitch / 127) * height;
            
            // Map time to X position based on transport loop length (8 measures)
            const loopDuration = 8 * 4 * 60 / state.bpm; // 8 measures in seconds
            const startX = ((note.time % loopDuration) / loopDuration) * width;
            const noteWidth = (note.duration / loopDuration) * width;
            
            // Active notes are brighter
            const currentTime = Tone.Transport.seconds;
            const isActive = note.time <= currentTime && note.time + note.duration >= currentTime;
            
            // Determine color based on note range (melody, chord, or bass)
            let noteColor;
            if (noteNumber > 60) {
              noteColor = isActive ? '#05ffa1' : '#05d787'; // Melody - green
            } else if (noteNumber > 48) {
              noteColor = isActive ? '#fee440' : '#e6cd3c'; // Chords - yellow
            } else {
              noteColor = isActive ? '#ff2a6d' : '#d62258'; // Bass - pink
            }
            
            // Draw note with glow
            ctx.save();
            if (isActive) {
              ctx.shadowColor = noteColor;
              ctx.shadowBlur = 15;
            }
            ctx.fillStyle = noteColor;
            ctx.globalAlpha = isActive ? 0.9 : 0.6;
            
            // Rounded rectangle for notes
            const noteHeight = 8;
            const cornerRadius = 4;
            ctx.beginPath();
            ctx.moveTo(startX + cornerRadius, y - noteHeight/2);
            ctx.lineTo(startX + noteWidth - cornerRadius, y - noteHeight/2);
            ctx.quadraticCurveTo(startX + noteWidth, y - noteHeight/2, startX + noteWidth, y - noteHeight/2 + cornerRadius);
            ctx.lineTo(startX + noteWidth, y + noteHeight/2 - cornerRadius);
            ctx.quadraticCurveTo(startX + noteWidth, y + noteHeight/2, startX + noteWidth - cornerRadius, y + noteHeight/2);
            ctx.lineTo(startX + cornerRadius, y + noteHeight/2);
            ctx.quadraticCurveTo(startX, y + noteHeight/2, startX, y + noteHeight/2 - cornerRadius);
            ctx.lineTo(startX, y - noteHeight/2 + cornerRadius);
            ctx.quadraticCurveTo(startX, y - noteHeight/2, startX + cornerRadius, y - noteHeight/2);
            ctx.fill();
            ctx.restore();
          });
          
          // Draw note history indicators on right side with glow
          state.noteHistory.forEach((note, i) => {
            const noteNumber = Tone.Frequency(note).toMidi();
            const normalizedPitch = 127 - noteNumber; // Flip so higher notes are at the top
            const y = (normalizedPitch / 127) * height;
            
            ctx.save();
            ctx.shadowColor = '#05ffa1';
            ctx.shadowBlur = 10;
            ctx.fillStyle = '#05ffa1';
            ctx.globalAlpha = 0.2 + 0.8 * (i / state.noteHistory.length);
            ctx.beginPath();
            ctx.arc(width - 15, y, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
          });
          
          animationId = requestAnimationFrame(drawVisualizer);
        }
        
        drawVisualizer();
      }
      
      // Initialize audio system immediately
      initAudioSystem();
      
      // Event listeners
      playStopButton.addEventListener('click', togglePlay);
      exportMidiButton.addEventListener('click', exportMidi);
      toggleMixerButton.addEventListener('click', toggleMixer);
      toggleMelodyButton.addEventListener('click', toggleMelodyStyle);
      toggleBassButton.addEventListener('click', toggleBassStyle);
      
      // BPM control
      bpmSlider.addEventListener('input', function() {
        state.bpm = parseInt(this.value);
        bpmValue.textContent = state.bpm;
        updateAudioParams();
      });
      
      // Scale selector
  // Replace the scale selector event listener with this:
scaleSelector.addEventListener('change', (e) => {
  state.scale = e.target.value;
  updateInfoPanel();
  
  // If not playing, just update the UI
  if (!state.isPlaying) return;
  
  // Generate new melody with new scale
  const newMelody = generateMelody();
  
  // Update melody part in real-time
  if (part) {
    part.dispose();
  }
  part = new Tone.Part((time, note) => {
    synth.triggerAttackRelease(note.note, note.duration, time);
    
    // Add note to history for visualization
    state.noteHistory.push(note.note);
    if (state.noteHistory.length > 16) {
      state.noteHistory = state.noteHistory.slice(-16);
    }
  }, newMelody).start(0);
  
  // Generate new chord progression
  const newChords = generateChordProgression();
  
  // Update chord part in real-time
  if (sequence) {
    sequence.dispose();
  }
  sequence = new Tone.Sequence((time, idx) => {
    if (idx < newChords.length) {
      const currentChord = newChords[idx];
      chord.triggerAttackRelease(currentChord, "1n", time);
    }
  }, [...Array(newChords.length).keys()], "1m").start(0);
  
  // Update bass line correctly
  const newBassline = generateBassline(newChords);
  if (bassLine) {
    bassLine.dispose();
  }
  
  // Create new bass line with proper parameter handling
  bassLine = new Tone.Part((time, event) => {
    // Correctly extract note and duration
    const noteValue = event.note;
    const durationValue = event.duration;
    
    bass.triggerAttackRelease(noteValue, durationValue, time);
    
    // Record bass note for visualization
    state.recordedNotes.push({
      note: noteValue,
      time: Tone.Transport.seconds + Tone.Time(time).toSeconds(),
      duration: Tone.Time(durationValue).toSeconds()
    });
  }, newBassline).start(0);
});
      
      // Root note selector
// Replace the root selector event listener with this:
rootSelector.addEventListener('change', function() {
  state.root = this.value;
  updateInfoPanel();
  
  // If not playing, just update the UI
  if (!state.isPlaying) return;
  
  // Update the melody, chords and bass with the new root note
  const newMelody = generateMelody();
  const newChords = generateChordProgression();
  const newBassline = generateBassline(newChords);
  
  // Update parts
  if (part) {
    part.dispose();
    part = new Tone.Part((time, note) => {
      synth.triggerAttackRelease(note.note, note.duration, time);
      
      // Add note to history for visualization
      state.noteHistory.push(note.note);
      if (state.noteHistory.length > 16) {
        state.noteHistory = state.noteHistory.slice(-16);
      }
    }, newMelody).start(0);
  }
  
  if (sequence) {
    sequence.dispose();
    sequence = new Tone.Sequence((time, idx) => {
      if (idx < newChords.length) {
        chord.triggerAttackRelease(newChords[idx], "1n", time);
      }
    }, [...Array(newChords.length).keys()], "1m").start(0);
  }
  
  if (bassLine) {
    bassLine.dispose();
    bassLine = new Tone.Part((time, event) => {
      // Properly extract note properties
      const noteValue = event.note;
      const durationValue = event.duration;
      bass.triggerAttackRelease(noteValue, durationValue, time);
      
      // Record bass note for visualization
      state.recordedNotes.push({
        note: noteValue,
        time: Tone.Transport.seconds + Tone.Time(time).toSeconds(),
        duration: Tone.Time(durationValue).toSeconds()
      });
    }, newBassline).start(0);
  }
});
      
      // Melody density knob
      densityInput.addEventListener('input', function() {
        state.melodyDensity = parseFloat(this.value);
        densityValue.textContent = state.melodyDensity;
        updateKnob(densityKnob, state.melodyDensity, 0.1, 1);
        updateInfoPanel();
      });
      
      // Melody octave knob
      octaveInput.addEventListener('input', function() {
        state.melodyOctave = parseInt(this.value);
        octaveValue.textContent = state.melodyOctave;
        updateKnob(octaveKnob, state.melodyOctave, 3, 6);
        updateInfoPanel();
      });
      
      // Reverb knob
      reverbInput.addEventListener('input', function() {
        state.melodyReverbLevel = parseFloat(this.value);
        reverbValue.textContent = state.melodyReverbLevel;
        updateKnob(reverbKnob, state.melodyReverbLevel, 0, 1);
        updateAudioParams();
      });
      
      // Delay knob
      delayInput.addEventListener('input', function() {
        state.melodyDelayLevel = parseFloat(this.value);
        delayValue.textContent = state.melodyDelayLevel;
        updateKnob(delayKnob, state.melodyDelayLevel, 0, 1);
        updateAudioParams();
      });
      
      // Volume sliders
      
      melodyVolumeSlider.addEventListener('input', function() {
  state.melodyVolume = parseInt(this.value);
  melodyVolumeValue.textContent = state.melodyVolume;
  
  // If a melody is currently playing, update its volume and regenerate
  if (state.isPlaying) {
    // If a previous part exists, dispose of it
    if (part) {
      part.dispose();
    }
    
    // Regenerate the melody with the current style and new volume
    updateMelodyStyle();
  }
  
  // Ensure the audio parameters are updated globally
  updateAudioParams();
});
      
      chordVolumeSlider.addEventListener('input', function() {
        state.chordVolume = parseInt(this.value);
        chordVolumeValue.textContent = state.chordVolume;
        updateAudioParams();
      });
      
      bassVolumeSlider.addEventListener('input', function() {
        state.bassVolume = parseInt(this.value);
        bassVolumeValue.textContent = state.bassVolume;
        updateAudioParams();
      });
      
      drumsVolumeSlider.addEventListener('input', (e) => {
        state.drumsVolume = parseInt(e.target.value);
        drumsVolumeValue.textContent = `${state.drumsVolume} dB`;
        updateAudioParams();
      });
      
      drumsPatternSelect.addEventListener('change', (e) => {
        state.drumsPattern = e.target.value;
        if (state.isPlaying) {
          togglePlay().then(() => togglePlay());
        }
      });
      
      masterVolumeSlider.addEventListener('input', (e) => {
        state.masterVolume = parseInt(e.target.value);
        masterVolumeValue.textContent = state.masterVolume;
        Tone.Destination.volume.value = state.masterVolume;
      });
      
      // Melody style controls
      melodyStyleSelect.addEventListener('change', (e) => {
        state.melodyStyle = e.target.value;
        updateMelodyStyle();
      });
      
      complexitySlider.addEventListener('input', (e) => {
        state.complexity = parseInt(e.target.value);
        complexityValue.textContent = `${state.complexity}%`;
        updateMelodyStyle();
      });
      
      doublingSelect.addEventListener('change', (e) => {
        state.doubling = e.target.value;
        updateMelodyStyle();
      });
      
      rhythmicVariationSlider.addEventListener('input', (e) => {
        state.rhythmicVariation = parseInt(e.target.value);
        rhythmicVariationValue.textContent = `${state.rhythmicVariation}%`;
        updateMelodyStyle();
      });
      
      noteDurationSlider.addEventListener('input', (e) => {
        state.noteDuration = parseInt(e.target.value);
        noteDurationValue.textContent = `${state.noteDuration}%`;
        updateMelodyStyle();
      });
      
      phrasingSelect.addEventListener('change', (e) => {
        state.phrasing = e.target.value;
        updateMelodyStyle();
      });
      
      // Bass style controls
      bassStyleSelect.addEventListener('change', (e) => {
        state.bassStyle = e.target.value;
        updateBassStyle();
      });
      
      bassComplexitySlider.addEventListener('input', (e) => {
        state.bassComplexity = parseInt(e.target.value);
        bassComplexityValue.textContent = `${state.bassComplexity}%`;
        updateBassStyle();
      });
      
      bassRhythmicVariationSlider.addEventListener('input', (e) => {
        state.bassRhythmicVariation = parseInt(e.target.value);
        bassRhythmicVariationValue.textContent = `${state.bassRhythmicVariation}%`;
        updateBassStyle();
      });
      
      // Function to update melody based on style parameters
     function updateMelodyStyle() {
  if (!state.isPlaying) return;
  
  // Generate new melody with current style parameters
  const newMelody = generateMelody();
  
  // Update melody part in real-time
  if (part) {
    part.dispose();
  }
  
  // Create a polyphonic synth to handle doubled notes
  const polySynth = new Tone.PolySynth(Tone.Synth, {
    volume: state.melodyVolume, // Preserve the current melody volume
    envelope: {
      attack: 0.02,
      decay: 0.1,
      sustain: 0.3,
      release: 0.5
    }
  }).connect(delay); // Connect to delay instead of reverb to maintain effects chain
  
  part = new Tone.Part((time, note) => {
    // Apply style modifications
    let duration = note.duration;
    let velocity = note.velocity || 0.7; // Default velocity if not set
    
    // Modify note based on style
    switch (state.melodyStyle) {
      case 'staccato':
        duration = '16n'; // Slightly longer than before to avoid timing issues
        velocity = 0.8;
        break;
      case 'legato':
        duration = '4n';
        velocity = 0.6;
        break;
      case 'swing':
        // Add slight timing variation for swing feel
        time += (Math.random() * 0.03 - 0.015); // Reduced variation
        break;
    }
    
    // Apply doubling
    if (state.doubling !== 'none') {
      const interval = {
        'octave': 12,
        'fifth': 7,
        'third': 4
      }[state.doubling];
      
      if (interval) {
        const doubledNote = Tone.Frequency(note.note).transpose(interval).toNote();
        // Use polySynth for doubled notes
        polySynth.triggerAttackRelease(doubledNote, duration, time, velocity * 0.6);
      }
    }
    
    // Use polySynth for main note too
    polySynth.triggerAttackRelease(note.note, duration, time, velocity);
    
    // Add note to history for visualization
    state.noteHistory.push({
      note: note.note,
      time: Tone.Transport.seconds,
      velocity: velocity
    });
    
    // Keep history at reasonable size
    if (state.noteHistory.length > 32) {
      state.noteHistory = state.noteHistory.slice(-32);
    }
  }, newMelody).start(0);
  
  // Update the melody volume slider to reflect current volume
  melodyVolumeSlider.value = state.melodyVolume;
  melodyVolumeValue.textContent = state.melodyVolume;
  
  // Clean up old synth when switching styles
  return () => {
    if (polySynth) {
      polySynth.dispose();
    }
  };
}
      

      
      // Function to update bass style
function updateBassStyle() {
  if (!state.isPlaying) return;
  
  // Generate new chord progression based on current scale/root
  const chords = generateChordProgression();
  
  // Generate new bassline with current style parameters
  const newBassline = generateBassline(chords);
  
  // Update the bass sound based on style
  updateBassSynthSettings();
  
  // Update bass part in real-time
  if (bassLine) {
    bassLine.dispose();
  }
  
  // Create new bass part - THIS IS THE FIX: properly extract note properties
  bassLine = new Tone.Part((time, event) => {
    // Add rhythmic variation based on style and variation parameter
    let adjustedTime = time;
    if (state.bassStyle === 'groovy' || state.bassStyle === 'walking') {
      const variationAmount = state.bassRhythmicVariation / 100;
      // Add subtle timing variation
      adjustedTime += (Math.random() * 0.02 - 0.01) * variationAmount;
    }
    
    // Extract the actual note and duration from the event
    const noteValue = event.note;
    const durationValue = event.duration;
    
    // Adjust velocity based on beat position and style
    let velocity = 0.8;
    if (state.bassStyle === 'syncopated') {
      // Emphasize syncopated notes
      velocity = 0.9;
    } else if (event.time && event.time.includes(':0:0')) {
      // Emphasize downbeats
      velocity = 0.9;
    }
    
    // Play the bass note with properly extracted parameters
    bass.triggerAttackRelease(noteValue, durationValue, adjustedTime, velocity);
    
    // Record for visualization
    state.recordedNotes.push({
      note: noteValue,
      time: adjustedTime, // Use the adjusted time directly
      duration: Tone.Time(durationValue).toSeconds()
    });
    
  }, newBassline).start(0);
  
  console.log("Bass style updated:", state.bassStyle);
}

// Helper function to update bass synth settings based on style
function updateBassSynthSettings() {
  if (!bass) return;
  
  // Base settings
  const baseSettings = {
    volume: state.bassVolume,
    envelope: {
      attack: 0.05,
      decay: 0.2,
      sustain: 0.8,
      release: 1.5
    },
    filterEnvelope: {
      attack: 0.05,
      decay: 0.5,
      sustain: 0.2,
      release: 2,
      baseFrequency: 200,
      octaves: 2
    }
  };
  
  // Modify settings based on style
  switch(state.bassStyle) {
    case 'simple':
      // Full, sustained bass
      bass.set({
        oscillator: { type: "sine" },
        envelope: {
          ...baseSettings.envelope,
          attack: 0.08,
          sustain: 0.9,
          release: 2
        }
      });
      break;
      
    case 'walking':
      // More defined attack, less sustain for walking bass
      bass.set({
        oscillator: { type: "triangle" },
        envelope: {
          ...baseSettings.envelope,
          attack: 0.02,
          decay: 0.15,
          sustain: 0.6,
          release: 0.8
        },
        filterEnvelope: {
          ...baseSettings.filterEnvelope,
          baseFrequency: 300,
          octaves: 3
        }
      });
      break;
      
    case 'groovy':
      // Punchier, more resonant sound for groove patterns
      bass.set({
        oscillator: { type: "triangle4" },
        envelope: {
          ...baseSettings.envelope,
          attack: 0.01,
          decay: 0.3,
          sustain: 0.5,
          release: 0.6
        },
        filterEnvelope: {
          ...baseSettings.filterEnvelope,
          attack: 0.02,
          decay: 0.2,
          baseFrequency: 400,
          octaves: 4
        }
      });
      break;
      
    case 'syncopated':
      // Sharp attack for clear syncopation
      bass.set({
        oscillator: { type: "fmsquare" },
        envelope: {
          ...baseSettings.envelope,
          attack: 0.005,
          decay: 0.1,
          sustain: 0.3,
          release: 0.4
        },
        filterEnvelope: {
          ...baseSettings.filterEnvelope,
          attack: 0.01,
          decay: 0.1,
          baseFrequency: 500,
          octaves: 5
        }
      });
      break;
  }
}
      
      // Update canvas size when window resizes
      window.addEventListener('resize', function() {
        if (visualizer) {
          visualizer.width = visualizer.clientWidth;
          visualizer.height = visualizer.clientHeight;
        }
      });
    });
  </script>
</body>
</html>
